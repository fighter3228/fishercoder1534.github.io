
<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="google-site-verification" content="ng8ArJlQD3KevwWdP1sDNqlJt8bjcxsSLN0BRHJ95T0" />

      <meta name="twitter:card" content="summary_large_image" />

         <meta name="twitter:creator" content="@dbeck74" />
         <meta name="twitter:image" content="http://dbeck.github.io/images/DSCF6937.JPG" />
         <meta name="twitter:image:src" content="http://dbeck.github.io/images/DSCF6937.JPG" />

      <meta name="twitter:site" content="@dbeck74" />
      <meta name="twitter:title" content="5 Lessons Learnt From Choosing Zeromq And Protobuf" />



      <meta name="description" content="5 lessons learnt from choosing ZeroMQ + Protocol Buffers" />

        <meta name="twitter:description" content="5 lessons learnt from choosing ZeroMQ + Protocol Buffers" />




      <meta name="keywords" content="Distributed, ZeroMQ, Protocol Buffers, Programming, Performance" />


    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css' />
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print" />



    <title> 5 Lessons Learnt From Choosing Zeromq And Protobuf </title>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript">
    blockme = false;
    skipme = false;
    var blocklink = ['http://law-enforcement-ff.xyz', 'http://social-widget.xyz', 'http://darodar.com', 'http://econom.co','http://ilovevitaly.com',
'http://topseoservices.co' ,'http://traffic2cash.xyz' ,'http://w3javascript.com' ,'http://googlemare.com' ,'http://share-buttons.xyz'
,'http://website-stealer.nufaq.com' ,'http://build-a-better-business.2your.site' ,'http://santasgift.ml' ,'http://topseoservices.co'
,'http://new-look.for-your.website' ,'http://popurls.com' ,'http://smarter-content.for-your.website' ,'http://trafficgenius.xyz'
,'http://build-audience.for-your.website' ,'http://tuicool' ,'http://happy.new.yeartwit.com' ,'http://ustart.org'
,'http://semalt.com' ,'http://buttons-for-website.com' ,'http://top1-seo-service.com', 'http://quit-smoking.ga'];
    for (var b = blocklink.length; b--; ) {
      if (document.referrer.includes(blocklink[b])) {
        blockme = true;
      }
    }
    if (document.domain.includes('127.0.0.1') ) {
      skipme = true;
    }
    if (document.referrer.includes('http://127.0.0.1') ) {
      skipme = true;
    }


      if( blockme == false ) {
        if( skipme == false) {
          (function(){
            var t,i,e,n=window,o=document,a=arguments,s="script",r=["config","track","identify","visit","push","call","trackForm","trackClick"],c=function(){var t,i=this;for(i._e=[],t=0;r.length>t;t++)(function(t){i[t]=function(){return i._e.push([t].concat(Array.prototype.slice.call(arguments,0))),i}})(r[t])};for(n._w=n._w||{},t=0;a.length>t;t++)n._w[a[t]]=n[a[t]]=n[a[t]]||new c;i=o.createElement(s),i.async=1,i.src="//static.woopra.com/js/t/5.js",e=o.getElementsByTagName(s)[0],e.parentNode.insertBefore(i,e)})("woopra");

          woopra.config({ domain: 'dbeck.github.io' });
          woopra.track();

          woopra.track( "zeromqprotobuf", { displayed: true } );

        }
      }
    if( blockme == false ) {
      if( skipme == false ) {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        var app_le = 'UA';
        var pe_ach = '922';
        var c_r = app_le+'-63'+pe_ach+'309'+'-1';
        ga('create', c_r, 'auto');
        ga('send', 'pageview');
      }
    }
    else {
      window.location = 'http://google.com/';
     }
    </script>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>David Beck</h1>
        <h2>Thoughts</h2>
        <a href="https://github.com/dbeck" class="button"><small>Follow on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">

          <h2>5 Lessons Learnt From Choosing Zeromq And Protobuf</h2>
<p class="meta">17 Sep 2015 by <a href="/about">David Beck</a> on [<a href="https://hu.linkedin.com/in/davidbeckhungary">LinkedIn</a>] / [<a href="feed://dbeck.github.io/feed.xml">Feed</a>] <br/> <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false"> <img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /> </a> <a href="https://twitter.com/dbeck74" class="twitter-follow-button" data-show-count="false">Follow @dbeck74</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script> <a href="https://twitter.com/share" class="twitter-share-button" data-via="dbeck74">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script> </p>

<p>We implemented a new distributed system from scratch. One of the goals was to make this extendible by adding new components easily in different programming languages. I was looking for a solution to pass serialized data between them without worrying too much about performance and cross language compatibility. This practically ruled out a few popular options at square one, like HTTP, Json, XML, Web Services. Fortunately there were quite some others:</p>

<ul>
  <li><a href="http://zeromq.org">ZeroMQ</a> + <a href="https://developers.google.com/protocol-buffers/?hl=en">Protobuf</a></li>
  <li><a href="https://thrift.apache.org">Thrift</a></li>
  <li><a href="https://avro.apache.org/docs/current/">Avro</a></li>
</ul>

<p>Originally these options didn’t look like very different. All have efficient serialization. Handle data transport between components and cover many programming languages.</p>

<p>I liked ZeroMQ + Protobuf option better than the others because it sounded like well optimized transport with Publish-Subscribe built in.</p>

<p>This topic is about a few of our experiences that we earnt the hard way.</p>

<h3 id="zeromq-request-reply">1. ZeroMQ Request Reply</h3>

<p>If I were creating the ZeroMQ docs I would start with “Don’t use REQ-REP because there is very little chance that it does what you need”. What I found instead is that it starts describing REQ-REP as a showcase of how easy it is to use ZeroMQ.</p>

<p>The issue with REQ-REP is that it allows one request to be served in parallel and due to the fact that it requires to send a reply for every request it is very fragile.</p>

<p>Example: I have a third party service that I want to wrap in a ZeroMQ interface. I am receiving ZeroMQ requests that I translate into a native request to this third party service. If this external service becomes slow or stops responding than it becomes very inconvenient to handle this on the ZeroMQ side.</p>

<p>Advice: use REQ-ROUTER sockets all the time because REP sockets are pretty useless for any real world application.</p>

<h3 id="zeromq-portability">2. ZeroMQ Portability</h3>

<p>When I read the docs I was happy to see that ZeroMQ has many language bindings so this is pretty portable. In other places I read that it is secure thanks to the developments introduced in 4.x and upwards. What people forgot to mention is that these two don’t happen at the same time.</p>

<p>Even if there is a security model in 4.x, it is not available in many language bindings that I was interested in. These are niche languages that very few people use like <a href="http://zeromq.org/bindings:java">Java</a> that has no support for 4.x. Other less common choices like Erlang, Elixir are also unavailable if you want security.</p>

<h3 id="protocol-buffers-performance">3. Protocol Buffers Performance</h3>

<p>I trusted protobuf quite a lot at the beginning of the project even to the point when we ran into a performance issue I was rather looking at very unlikely places than protobuf. When I analyzed the issue further it slowly became clear that protobuf has a few weaknesses. Memory allocation is the biggest.</p>

<p>In our case we passed values in arrays. It turned out that passing string arrays is hopelessly slow and passing numeric types in arrays is about twice as slow as it could be. The reason is memory allocation. Protobuf allocates a string object for each string item it receives in the array. A typical message in our system has 25.000 strings or numerics in the array we pass.</p>

<p>I chose to write a deserializer for this one message type that reuses the tag bytes as zero terminator between the elements in the string array. For the numeric types I preallocated a large enough buffer in one step to place my items into that. Ther result is 20x faster for strings and twice as fast for numeric types.</p>

<p>Advice: look at <a href="https://google.github.io/flatbuffers/md__benchmarks.html">flatbuffers</a></p>

<h3 id="protocol-buffers-size-constraints">4. Protocol Buffers Size Constraints</h3>

<p>The default message size limit is 64MB for protocol buffers. This can be changed. In our case, for every single programming language that we want to support. Not very convenient.</p>

<h3 id="protocol-buffers-enums">5. Protocol Buffers Enums</h3>

<p>One often advertised feature of protobuf is that it is easy to be extended by new messages. We created a wrapper message with an enum to tell what kind of optional message follows. This allowed us to occasionally add new message types into the outer wrapper. We realized afterwards that different language bindings have different tolerance for this approach.</p>

<p>Hint: C++ and Javascript differs significantly.</p>





<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'davidbeck';
    var disqus_title = '5 Lessons Learnt From Choosing Zeromq And Protobuf';

      var disqus_identifier = 'davidbeck/zeromqprotobuf/5 Lessons Learnt From Choosing Zeromq And Protobuf';


    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        </section>
        <aside id="sidebar">
         <h3>
           [<a href="feed://dbeck.github.io/feed.xml">Feed</a>] /
           <a href="/">Home</a>
         </h3>





          <h3 id="0mq">0mq</h3>
          <ul>

              <li><a href="/5-lessons-learnt-from-choosing-zeromq-and-protobuf/">5 Lessons Learnt From Choosing Zeromq And Protobuf</a></li>

          </ul>

          <h3 id="CRDT">CRDT</h3>
          <ul>

              <li><a href="/Scalesmall-W2-First-Redesign/">Scalesmall W2 First Redesign</a></li>

          </ul>

          <h3 id="ETS">ETS</h3>
          <ul>

              <li><a href="/Scalesmall-W8-W10-Elixir-Tuples-Maps-and-ETS/">Scalesmall W8 W10 Elixir Tuples Maps And Ets</a></li>

          </ul>

          <h3 id="Linux">Linux</h3>
          <ul>

              <li><a href="/system-five-semaphores/">System Five Semaphores</a></li>

          </ul>

          <h3 id="Rust">Rust</h3>
          <ul>

              <li><a href="/Example-Source-and-Sink/">Example: Source And Sink</a></li>

              <li><a href="/Rust-Actor-Library-Follow-up/">Rust Actor Library: Follow Up</a></li>

              <li><a href="/Rust-Actor-Library-First-assorted-thoughts/">Rust Actor Library: First Assorted Thoughts</a></li>

              <li><a href="/Learning-Rust-Sharing-My-Queue-Between-Threads/">Learning Rust: Sharing My Queue Between Threads</a></li>

              <li><a href="/Learning-Rust-Yet-Another-Lock-Free-Queue/">Learning Rust: Yet Another Lock Free Queue</a></li>

              <li><a href="/Learning-Rust-Iterator/">Learning Rust: Iterator</a></li>

              <li><a href="/Learning-Rust-Closures/">Learning Rust: Closures</a></li>

              <li><a href="/My-First-Steps-In-Rust/">My First Steps In Rust</a></li>

          </ul>

          <h3 id="TCP">TCP</h3>
          <ul>

              <li><a href="/Chatter-extracted-from-ScaleSmall/">Chatter Extracted From Scalesmall</a></li>

              <li><a href="/Scalesmall-W5-UDP-Multicast-Mixed-With-TCP/">Scalesmall W5 Udp Multicast Mixed With Tcp</a></li>

              <li><a href="/Wrapping-up-my-Elixir-TCP-experiments/">Wrapping Up My Elixir Tcp Experiments</a></li>

              <li><a href="/Passing-Millions-Of-Small-TCP-Messages-in-Elixir/">Passing Millions Of Small Tcp Messages In Elixir</a></li>

              <li><a href="/Over-Two-Times-Speedup-By-Better-Elixir-Code/">Over Two Times Speedup By Better Elixir Code</a></li>

              <li><a href="/Four-Times-Speedup-By-Throttling/">Four Times Speedup By Throttling</a></li>

              <li><a href="/simple-TCP-message-performance-in-Elixir/">Simple Tcp Message Performance In Elixir</a></li>

              <li><a href="/Using-Ranch-From-Elixir/">Using Ranch From Elixir</a></li>

          </ul>

          <h3 id="UDP-Multicast">UDP-Multicast</h3>
          <ul>

              <li><a href="/Chatter-extracted-from-ScaleSmall/">Chatter Extracted From Scalesmall</a></li>

              <li><a href="/Scalesmall-W5-UDP-Multicast-Mixed-With-TCP/">Scalesmall W5 Udp Multicast Mixed With Tcp</a></li>

          </ul>

          <h3 id="actor">actor</h3>
          <ul>

              <li><a href="/Example-Source-and-Sink/">Example: Source And Sink</a></li>

              <li><a href="/Rust-Actor-Library-Follow-up/">Rust Actor Library: Follow Up</a></li>

              <li><a href="/Rust-Actor-Library-First-assorted-thoughts/">Rust Actor Library: First Assorted Thoughts</a></li>

          </ul>

          <h3 id="chatter">chatter</h3>
          <ul>

              <li><a href="/Chatter-extracted-from-ScaleSmall/">Chatter Extracted From Scalesmall</a></li>

          </ul>

          <h3 id="concurrency">concurrency</h3>
          <ul>

              <li><a href="/Example-Source-and-Sink/">Example: Source And Sink</a></li>

              <li><a href="/Rust-Actor-Library-Follow-up/">Rust Actor Library: Follow Up</a></li>

              <li><a href="/Rust-Actor-Library-First-assorted-thoughts/">Rust Actor Library: First Assorted Thoughts</a></li>

          </ul>

          <h3 id="database">database</h3>
          <ul>

              <li><a href="/database-external-tables/">Database External Tables</a></li>

          </ul>

          <h3 id="distributed">distributed</h3>
          <ul>

              <li><a href="/Scalesmall-W5-UDP-Multicast-Mixed-With-TCP/">Scalesmall W5 Udp Multicast Mixed With Tcp</a></li>

              <li><a href="/Scalesmall-W4-Message-Contents-Finalized/">Scalesmall W4 Message Contents Finalized</a></li>

              <li><a href="/Scalesmall-Experiment-Begins/">Scalesmall Experiment Begins</a></li>

              <li><a href="/dream-of-a-nice-distributed-system/">Dream Of A Nice Distributed System</a></li>

          </ul>

          <h3 id="elixir">elixir</h3>
          <ul>

              <li><a href="/Chatter-extracted-from-ScaleSmall/">Chatter Extracted From Scalesmall</a></li>

              <li><a href="/Scalesmall-W14-More-Group-Manager-Information/">Scalesmall W14 More Group Manager Information</a></li>

              <li><a href="/Scalesmall-W11-W13-Group-Manager-Implementation/">Scalesmall W11 W13 Group Manager Implementation</a></li>

              <li><a href="/Scalesmall-W8-W10-Elixir-Tuples-Maps-and-ETS/">Scalesmall W8 W10 Elixir Tuples Maps And Ets</a></li>

              <li><a href="/Scalesmall-W5-UDP-Multicast-Mixed-With-TCP/">Scalesmall W5 Udp Multicast Mixed With Tcp</a></li>

              <li><a href="/Scalesmall-W4-Message-Contents-Finalized/">Scalesmall W4 Message Contents Finalized</a></li>

              <li><a href="/Scalesmall-W3-Elixir-Macro-Guards/">Scalesmall W3 Elixir Macro Guards</a></li>

              <li><a href="/Scalesmall-W2-First-Redesign/">Scalesmall W2 First Redesign</a></li>

              <li><a href="/Scalesmall-W1-Combininig-Events/">Scalesmall W1 Combininig Events</a></li>

              <li><a href="/Scalesmall-Experiment-Begins/">Scalesmall Experiment Begins</a></li>

              <li><a href="/Non-Scientific-Measurement-of-Elixir-Remote-Calls/">Non Scientific Measurement Of Elixir Remote Calls</a></li>

              <li><a href="/Wrapping-up-my-Elixir-TCP-experiments/">Wrapping Up My Elixir Tcp Experiments</a></li>

              <li><a href="/Passing-Millions-Of-Small-TCP-Messages-in-Elixir/">Passing Millions Of Small Tcp Messages In Elixir</a></li>

              <li><a href="/Over-Two-Times-Speedup-By-Better-Elixir-Code/">Over Two Times Speedup By Better Elixir Code</a></li>

              <li><a href="/Four-Times-Speedup-By-Throttling/">Four Times Speedup By Throttling</a></li>

              <li><a href="/simple-TCP-message-performance-in-Elixir/">Simple Tcp Message Performance In Elixir</a></li>

              <li><a href="/Using-Ranch-From-Elixir/">Using Ranch From Elixir</a></li>

              <li><a href="/dream-of-a-nice-distributed-system/">Dream Of A Nice Distributed System</a></li>

          </ul>

          <h3 id="gossip">gossip</h3>
          <ul>

              <li><a href="/Chatter-extracted-from-ScaleSmall/">Chatter Extracted From Scalesmall</a></li>

              <li><a href="/Scalesmall-W14-More-Group-Manager-Information/">Scalesmall W14 More Group Manager Information</a></li>

              <li><a href="/Scalesmall-W11-W13-Group-Manager-Implementation/">Scalesmall W11 W13 Group Manager Implementation</a></li>

          </ul>

          <h3 id="group-manager">group-manager</h3>
          <ul>

              <li><a href="/Scalesmall-W14-More-Group-Manager-Information/">Scalesmall W14 More Group Manager Information</a></li>

              <li><a href="/Scalesmall-W11-W13-Group-Manager-Implementation/">Scalesmall W11 W13 Group Manager Implementation</a></li>

          </ul>

          <h3 id="macro">macro</h3>
          <ul>

              <li><a href="/Scalesmall-W8-W10-Elixir-Tuples-Maps-and-ETS/">Scalesmall W8 W10 Elixir Tuples Maps And Ets</a></li>

              <li><a href="/Scalesmall-W3-Elixir-Macro-Guards/">Scalesmall W3 Elixir Macro Guards</a></li>

          </ul>

          <h3 id="performance">performance</h3>
          <ul>

              <li><a href="/5-People-To-Listen-To-About-Software-Performance/">5 People To Listen To About Software Performance</a></li>

              <li><a href="/Non-Scientific-Measurement-of-Elixir-Remote-Calls/">Non Scientific Measurement Of Elixir Remote Calls</a></li>

              <li><a href="/Wrapping-up-my-Elixir-TCP-experiments/">Wrapping Up My Elixir Tcp Experiments</a></li>

              <li><a href="/Experimental-Reliable-Small-Message-Protocol/">Experimental Reliable Small Message Protocol</a></li>

              <li><a href="/Passing-Millions-Of-Small-TCP-Messages-in-Elixir/">Passing Millions Of Small Tcp Messages In Elixir</a></li>

              <li><a href="/Over-Two-Times-Speedup-By-Better-Elixir-Code/">Over Two Times Speedup By Better Elixir Code</a></li>

              <li><a href="/Four-Times-Speedup-By-Throttling/">Four Times Speedup By Throttling</a></li>

              <li><a href="/simple-TCP-message-performance-in-Elixir/">Simple Tcp Message Performance In Elixir</a></li>

              <li><a href="/price-of-being-distributed/">Price Of Being Distributed</a></li>

          </ul>

          <h3 id="protobuf">protobuf</h3>
          <ul>

              <li><a href="/5-lessons-learnt-from-choosing-zeromq-and-protobuf/">5 Lessons Learnt From Choosing Zeromq And Protobuf</a></li>

          </ul>

          <h3 id="ranch">ranch</h3>
          <ul>

              <li><a href="/simple-TCP-message-performance-in-Elixir/">Simple Tcp Message Performance In Elixir</a></li>

              <li><a href="/Using-Ranch-From-Elixir/">Using Ranch From Elixir</a></li>

          </ul>

          <h3 id="reliability">reliability</h3>
          <ul>

              <li><a href="/Experimental-Reliable-Small-Message-Protocol/">Experimental Reliable Small Message Protocol</a></li>

          </ul>

          <h3 id="scalesmall">scalesmall</h3>
          <ul>

              <li><a href="/Chatter-extracted-from-ScaleSmall/">Chatter Extracted From Scalesmall</a></li>

              <li><a href="/Scalesmall-W14-More-Group-Manager-Information/">Scalesmall W14 More Group Manager Information</a></li>

              <li><a href="/Scalesmall-W11-W13-Group-Manager-Implementation/">Scalesmall W11 W13 Group Manager Implementation</a></li>

              <li><a href="/Scalesmall-W8-W10-Elixir-Tuples-Maps-and-ETS/">Scalesmall W8 W10 Elixir Tuples Maps And Ets</a></li>

              <li><a href="/Scalesmall-W6-W7-Test-environment/">Scalesmall W6 W7 Test Environment</a></li>

              <li><a href="/Scalesmall-W5-UDP-Multicast-Mixed-With-TCP/">Scalesmall W5 Udp Multicast Mixed With Tcp</a></li>

              <li><a href="/Scalesmall-W4-Message-Contents-Finalized/">Scalesmall W4 Message Contents Finalized</a></li>

              <li><a href="/Scalesmall-W3-Elixir-Macro-Guards/">Scalesmall W3 Elixir Macro Guards</a></li>

              <li><a href="/Scalesmall-W2-First-Redesign/">Scalesmall W2 First Redesign</a></li>

              <li><a href="/Scalesmall-W1-Combininig-Events/">Scalesmall W1 Combininig Events</a></li>

              <li><a href="/Scalesmall-Experiment-Begins/">Scalesmall Experiment Begins</a></li>

          </ul>

          <h3 id="semaphore">semaphore</h3>
          <ul>

              <li><a href="/system-five-semaphores/">System Five Semaphores</a></li>

          </ul>

          <h3 id="slowdata">slowdata</h3>
          <ul>

              <li><a href="/price-of-being-distributed/">Price Of Being Distributed</a></li>

          </ul>

        </aside>
      </div>
    </div>
  </body>
</html>
